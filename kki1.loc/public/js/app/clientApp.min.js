(function(){"use strict";angular.module("mds.areas",["ngCookies","oi.select"])})(),function(){"use strict";function n(n,t,i,r){function l(){var n=r.getConfig();n.then(function(n){a(n.data)},function(){alert("Error. Unable to get application configuration!")})}function a(t){n.$emit("config_loaded",t)}var u,o;l();var f=t.absUrl(),s=f.indexOf("#!"),h=s>-1?f.substring(0,s):f,c=h.indexOf("?"),e=c>-1?h.substring(c).split(/[&||?]/):[];for(u=0;u<e.length;u+=1)e[u].indexOf("=")>-1&&(o=e[u].split("="),t.search(o[0],o[1]))}angular.module("mds.areas").run(n);n.$inject=["$rootScope","$location","mapfactory","mapservice"]}(),function(){"use strict";function n(n,t,i){function u(n){r=n}function f(){function tt(n){var i=this,e=i._map,v=n.latlng,r=n.containerPoint,o=e.getSize(),s=e.getBounds(),h=i._url,u=i.options.crs||e.options.crs,c=u.project(s.getSouthWest()),l=u.project(s.getNorthEast()),f=i.wmsParams,a,t={service:"WMS",version:f.version,request:"GetFeatureInfo",layers:f.layers,styles:f.styles,cql_filter:"is_active = 'Y'",bbox:c.x+","+c.y+","+l.x+","+l.y,width:o.x,height:o.y,query_layers:ut(),info_format:"application/json",feature_count:5};parseFloat(f.version)>=1.3?(t.crs=u.code,t.i=r.x,t.j=r.y):(t.srs=u.code,t.x=r.x,t.y=r.y);a=h+L.Util.getParamString(t,h,!0);it(a,i,v)}function it(r,f,e){var o=i.reqBBOX(r);o.then(function(n){rt(n.data,f,e)},function(i){n.removeLayer(t);n.removeLayer(u);L.popup().setLatLng(e).setContent("Нет ответа от сервера: "+i.data).openOn(n)})}function rt(i,r,f){var e="",h=i.features,v,c,y,l,s;if(n.removeLayer(t),n.removeLayer(u),h.length){t=L.Proj.geoJson(i).addTo(n);c=0;for(y in h){l=h[y];s=l.properties;c>0&&(e+="<hr>");var o="",a="",p='<br/><a type="button" class="btn-success-min sidebar-open-button" href="/Main/SelectionMenu/'+l.id+'">Подать заявку по объекту<\/a><br/>';switch(s.obtypeuid){case"ЗНОП":o="ЗНОП городского значения";a=p;break;case"ОКН":o="Объекты культурного наследия";break;case"АД":o="Автомобильные дороги";break;case"Внутриквартальное озеленение":o="ЗНОП местного значения";a=p;break;default:o=s.obtypeuid}e+="Тип: "+o+"<br/>Объект: "+s.name+"<br/>";e+=a;c++}e+="<br/>";v=L.popup(null,r).setLatLng(f).setContent(e).openOn(n);r.on("popupclose",function(){n.removeLayer(t);r.off("popupclose",function(){})})}else e="Нет данных.<br/>",v=L.popup().setLatLng(f).setContent(e).openOn(n)}function ut(){var n="",t=h.getActiveOverlayLayers(),i=0;for(var r in t)t[r].layer.wmsParams.layers=="znop:zemuch"||(i>0&&(n+=","),n+=t[r].layer.wmsParams.layers,i++);return n}function et(n){var t=[];t.push(proj4(a,n));ot("Point",t)}function ot(t,r){var f=i.getSRPoint(t,r);f.then(function(t){n.removeLayer(u);u=L.geoJSON(t.data,{style:l}).addTo(n)},function(){alert("Нет ответа от сервера!")})}var a=r.MapReprojections.D_PULKOVO,f=L.tileLayer.wms(r.MapLayersLinks.TORIS,{maxZoom:19}),e=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:znop",opacity:0,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19,crs:L.CRS.EPSG3857}),st=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:mo",opacity:.5,format:"image/png",transparent:!0,maxZoom:19}),o=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:znop_gor",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),s=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:znop-local",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),v=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:facade",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),y=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:okn",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),p=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:vo",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),w=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:road_mo",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),b=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:ad",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),k=L.tileLayer.wms(r.MapLayersLinks.GeoserverWms,{layers:"znop:zemuch",opacity:.5,format:"image/png",transparent:!0,maxZoom:19}),t=L.geoJSON(),u=L.geoJSON(),n=L.map("Map",{center:[59.93863,30.31413],zoom:14,maxZoom:19,zoomControl:!1,crs:L.CRS.EPSG3857,layers:[f,e,o,s,t]}),d={"План":f},g={"ЗНОП городского значения":o,"ЗНОП местного значения":s,"Фасады":v,"Объекты культурного наследия":y,"Водные объекты":p,"Дороги":b,"Дороги внутри муниципальных образований":w,"Земельные участки и их части":k},h=L.control.activeLayers(d,g),c,nt,ft,l;h.addTo(n);L.control.zoom({zoomInTitle:"Приблизить",zoomOutTitle:"Отдалить"}).addTo(n);L.control.fullscreen({title:"На полный экран",titleCancel:"Свернуть карту"}).addTo(n);n.on("click",tt,e);c=L.tileLayer.wms(r.MapLayersLinks.MinMapToris,{maxZoom:19});nt=new L.Control.MiniMap(c,{toggleDisplay:!0}).addTo(n);ft=L.Control.geocoder({defaultMarkGeocode:!1,position:"topleft",placeholder:"Введите адрес",errorMessage:"Ничего не найдено",geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:r.MapServicesParams.NominatimAddress})}).on("markgeocode",function(t){var i=t.geocode.bbox,u=L.polygon([i.getSouthEast(),i.getNorthEast(),i.getNorthWest(),i.getSouthWest()]),r=[];r.push(t.geocode.center.lng);r.push(t.geocode.center.lat);et(r);n.fitBounds(u.getBounds())}).addTo(n);l={color:"#94b1c7",weight:5,opacity:.85}}var r;n.$on("config_loaded",function(n,t){u(t);f()})}angular.module("mds.areas").component("cmd",{template:'<div class="container-map"><div id="Map" class="adaptive-map"><\/div><\/div>',controller:n});angular.module("mds.areas").controller("cmdCNTRL",n);n.$inject=["$rootScope","$scope","mapservice","mapfactory"]}(),function(){"use strict";function n(n,t,i,r,u,f,e){function b(n){o=n}function d(){var n=u.getDistricts();n.then(function(n){i.districts=n.data},function(){alert("Невозможно получить данные по районам!")})}function g(){var n=u.getMunicipalDistricts();n.then(function(n){i.municipalDistricts=n.data;tt()},function(){alert("Невозможно получить данные по муницыпальным округам!")})}function nt(){var n=u.getZS();n.then(function(n){i.znst=n.data},function(){alert("Невозможно получить данные по статусам ЗНОП!")})}function tt(){function si(n,t,i){switch(n){case"0":t.addControl(i);break;case"3":t.addControl(i)}}function hi(n){var t=[];t.push(proj4(nt,n));ci("Point",t)}function ci(t,r){var f=u.getSRPoint(t,r);f.then(function(t){i.features=t.data.features;n.removeLayer(et);et=L.geoJson(t.data,{style:bt}).addTo(n)},function(){alert("Нет ответа от сервера!")})}function li(n){var p,w;if(c){var e=this,a=e._map,b=n.latlng,t=n.containerPoint,o=a.getSize(),y=a.getBounds(),s=e._url,u=e.options.crs||a.options.crs,h=u.project(y.getSouthWest()),l=u.project(y.getNorthEast()),f=e.wmsParams,i={service:"WMS",version:f.version,request:"GetFeatureInfo",layers:f.layers,styles:f.styles,cql_filter:"is_active = 'Y'",bbox:h.x+","+h.y+","+l.x+","+l.y,width:o.x,height:o.y,query_layers:ai(),info_format:"application/json",feature_count:5},r={service:"WMS",version:f.version,request:"GetFeatureInfo",layers:"znop:mo",styles:f.styles,bbox:h.x+","+h.y+","+l.x+","+l.y,width:o.x,height:o.y,propertyName:"НАЗВАНИЕ,РАЙОН",query_layers:"znop:mo",info_format:"application/json",feature_count:1};parseFloat(f.version)>=1.3?(i.crs=u.code,i.i=t.x,i.j=t.y,r.crs=u.code,r.i=t.x,r.j=t.y):(i.srs=u.code,i.x=t.x,i.y=t.y,r.srs=u.code,r.x=t.x,r.y=t.y);p=s+L.Util.getParamString(i,s,!0);w=s+L.Util.getParamString(r,s,!0);yi(w);vi(p,e,b);v=!1}}function ai(){var n="",t=lt.getActiveOverlayLayers(),i=0;for(var r in t)t[r].layer.wmsParams.layers==="znop:zemuch"?v=!0:(i>0&&(n+=","),n+=t[r].layer.wmsParams.layers,i++);return n}function vi(n,t,i){var r=u.reqBBOX(n);r.then(function(n){f.setJson(n.data);ki(t,i)},function(){alert("Нет ответа от сервера!")})}function yi(n){var t=u.reqBBOX(n);t.then(function(n){f.setDistr(n.data)},function(){alert("Нет ответа от сервера!")})}function pi(n){var t=u.getDistrBP(n);t.then(function(n){f.setDistr(n.data)},function(){alert("Нет ответа от сервера!")})}function wi(n){var t=u.getAddress(n);t.then(function(n){f.setAddr(n.data)},function(){alert("Нет ответа от сервера!")})}function bi(n,t){var i=u.getDistrBP(n);i.then(function(n){f.setDistr(n.data);f.setItemEvt(t,3)},function(){alert("Нет ответа от сервера!")})}function ki(t,i){var r=f.getJson();n.removeLayer(ut);n.removeLayer(et);ut=L.Proj.geoJson(r).addTo(n);pt.setLatLng(i).openOn(n)}function wt(){var t=f.getItem(),r=f.getDistr(),s,c,a,v,u,o;r&&(s=e("filter")(i.municipalDistricts,r.features[0].properties.НАЗВАНИЕ),c=e("filter")(i.districts,r.features[0].properties.РАЙОН),i.kKIZnopRequest.MunicipalDistrictId=s[0].id,i.kKIZnopRequest.DistrictId=c[0].id);t.properties.address||(a=f.getAddr(),v=", ",t.properties.address=it(a,v));t.properties.obtypeuid&&(i.kKIZnopRequest.SelectedStatusId=h(t.properties.obtypeuid));i.sftr=t;i.kKIZnopRequest.OIDSvyaz=t.properties.oid_;i.kKIZnopRequest.Objectid=t.properties.OBJECTID;i.kKIZnopRequest.ObjectName=t.properties.address;i.kKIZnopRequest.Address=t.properties.address;t&&(u=l(t.geometry),n.removeLayer(b),b=L.geoJson(u,{style:g}).addTo(n),o=b.getBounds().getCenter(),i.kKIZnopRequest.Lng=o.lng,i.kKIZnopRequest.Lat=o.lat,n.fitBounds(b.getBounds()),i.kKIZnopRequest.Geometry=u,n.closePopup())}function di(t){var r=f.getItem(),u=f.getDistr(),s,c,l,a,o;u&&(s=e("filter")(i.municipalDistricts,u.features[0].properties.НАЗВАНИЕ),c=e("filter")(i.districts,u.features[0].properties.РАЙОН),i.kKIZnopRequest.MunicipalDistrictId=s[0].id,i.kKIZnopRequest.DistrictId=c[0].id);r.properties.address||(l=f.getAddr(),a=", ",r.properties.address=it(l,a));r.properties.obtypeuid&&(i.kKIZnopRequest.SelectedStatusId=h(r.properties.obtypeuid));i.sftr=r;i.kKIZnopRequest.OIDSvyaz=r.properties.oid_;i.kKIZnopRequest.Objectid=r.properties.OBJECTID;i.kKIZnopRequest.ObjectName=r.properties.address;i.kKIZnopRequest.Address=r.properties.address;i.sftr=r;r&&(n.removeLayer(b),b=L.geoJson(t,{style:g}).addTo(n),o=b.getBounds().getCenter(),i.kKIZnopRequest.Lng=o.lng,i.kKIZnopRequest.Lat=o.lat,n.fitBounds(b.getBounds()),i.kKIZnopRequest.Geometry=t,n.closePopup())}function gi(t){var r,u,s,c,a,v,w,y,o;n.removeLayer(b);r=f.getItem();u=f.getDistr();u&&(s=e("filter")(i.municipalDistricts,u.features[0].properties.НАЗВАНИЕ),c=e("filter")(i.districts,u.features[0].properties.РАЙОН),i.kKIZnopRequest.MunicipalDistrictId=s[0].id,i.kKIZnopRequest.DistrictId=c[0].id);r.properties.address||(a=f.getAddr(),v=", ",r.properties.address=it(a,v));r.properties.obtypeuid&&(i.kKIZnopRequest.SelectedStatusId=h(r.properties.obtypeuid));i.sftr=r;i.kKIZnopRequest.OIDSvyaz=r.properties.oid_;i.kKIZnopRequest.Objectid=r.properties.OBJECTID;i.kKIZnopRequest.ObjectName=r.properties.address;i.kKIZnopRequest.Address=r.properties.address;r&&(w=l(r.geometry),t.features.push(rt(r.geometry)),n.removeLayer(b),y=L.geoJson(t),b=nr(y.getLayers()),b.addTo(n),o=b.getBounds().getCenter(),i.kKIZnopRequest.Lng=o.lng,i.kKIZnopRequest.Lat=o.lat,n.fitBounds(b.getBounds()),i.kKIZnopRequest.Geometry=p(b.toGeoJSON()),n.closePopup())}function nr(n){for(var r,i=[],t=0;t<n.length;++t)i.push(n[t].toGeoJSON());return r=turf.union.apply(this,i),L.geoJson(r,{style:g})}function tr(t){var r,u,a,v,y,w,s,o,k,c;if(n.removeLayer(b),r=f.getItem(),u=f.getDistr(),u&&(a=e("filter")(i.municipalDistricts,u.features[0].properties.НАЗВАНИЕ),v=e("filter")(i.districts,u.features[0].properties.РАЙОН),i.kKIZnopRequest.MunicipalDistrictId=a[0].id,i.kKIZnopRequest.DistrictId=v[0].id),r.properties.address||(y=f.getAddr(),w=", ",r.properties.address=it(y,w)),r.properties.obtypeuid&&(i.kKIZnopRequest.SelectedStatusId=h(r.properties.obtypeuid)),i.sftr=r,i.kKIZnopRequest.OIDSvyaz=r.properties.oid_,i.kKIZnopRequest.Objectid=r.properties.OBJECTID,i.kKIZnopRequest.ObjectName=r.properties.address,i.kKIZnopRequest.Address=r.properties.address,r){for(s=l(r.geometry),o=0;o<t.features.length;++o)s.features.push(t.features[o]);n.removeLayer(b);k=L.geoJson(s);b=ir(k.getLayers());b.addTo(n);c=b.getBounds().getCenter();i.kKIZnopRequest.Lng=c.lng;i.kKIZnopRequest.Lat=c.lat;n.fitBounds(b.getBounds());i.kKIZnopRequest.Geometry=p(b.toGeoJSON());n.removeLayer(d);d=L.geoJSON();d.addTo(n);n.closePopup()}}function ir(n){for(var r,i=[],t=0;t<n.length;++t)i.push(n[t].toGeoJSON());return r=turf.difference.apply(this,i),L.geoJson(r,{style:g})}function rr(t){var r,u,o,s,c,l;n.removeLayer(b);r=f.getItem();u=f.getDistr();u&&(o=e("filter")(i.municipalDistricts,u.features[0].properties.НАЗВАНИЕ),s=e("filter")(i.districts,u.features[0].properties.РАЙОН),i.kKIZnopRequest.MunicipalDistrictId=o[0].id,i.kKIZnopRequest.DistrictId=s[0].id);r.properties.address||(c=f.getAddr(),l=", ",r.properties.address=it(c,l));r.properties.obtypeuid&&(i.kKIZnopRequest.SelectedStatusId=h(r.properties.obtypeuid));i.sftr=r;i.kKIZnopRequest.OIDSvyaz=r.properties.oid_;i.kKIZnopRequest.Objectid=r.properties.OBJECTID;i.kKIZnopRequest.ObjectName=r.properties.address;i.kKIZnopRequest.Address=r.properties.address;r&&(n.removeLayer(b),b=L.geoJson(t,{style:g}).addTo(n),n.fitBounds(b.getBounds()),i.kKIZnopRequest.Geometry=t,n.closePopup())}function it(n,t){return n.address.town?n.address.house_number?"г."+n.address.town+t+n.address.road+t+"дом "+n.address.house_number:ur(n,t):n.address.house_number?"г.Санкт-Петербург"+t+n.address.road+t+"дом "+n.address.house_number:fr(n,t)}function ur(n,t){return n.address.road?n.namedetails.name?"г."+n.address.town+t+n.address.road+t+n.namedetails.name:n.display_name:n.namedetails.name?"г."+n.address.town+t+n.address.pedestrian+t+n.namedetails.name:n.display_name}function fr(n,t){return n.address.road?n.namedetails.name?"г.Санкт-Петербург"+t+n.address.road+t+n.namedetails.name:n.display_name:n.namedetails.name?"г.Санкт-Петербург"+t+n.address.pedestrian+t+n.namedetails.name:n.display_name}function er(t,r){if(i.kKIZnopRequest.TypeId=t,r){var e=u.getftrById(r);e.then(function(t){b=L.geoJson(t.data,{style:g}).addTo(n);n.fitBounds(b.getBounds());var r=b.getBounds().getCenter(),u=proj4(nt,[r.lng,r.lat]);f.setPolCtr(u);bi(u,t.data.features[0]);i.zs=h(t.data.features[0].properties.obtypeuid)},function(){alert("Нет ответа от сервера!")})}}var nt=o.MapReprojections.D_PULKOVO,ei,at,vt,oi,yt,pt,tt,g,bt,kt,ft;er(s,a);i.kKIZnopRequest.TypeId=s;var ot=L.tileLayer.wms(o.MapLayersLinks.TORIS,{maxZoom:19}),st=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:znop",opacity:0,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19,crs:L.CRS.EPSG4326}),or=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:mo",opacity:.5,format:"image/png",transparent:!0,maxZoom:19}),ht=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:znop_gor",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19,crs:L.CRS.EPSG4326}),ct=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:znop-local",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),dt=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:facade",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),gt=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:okn",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),ni=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:vo",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),ti=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:road_mo",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),ii=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:ad",opacity:.5,format:"image/png",cql_filter:"is_active = 'Y'",transparent:!0,maxZoom:19}),ri=L.tileLayer.wms(o.MapLayersLinks.GeoserverWms,{layers:"znop:zemuch",opacity:.5,format:"image/png",transparent:!0,maxZoom:19}),ut=L.geoJSON(),d=L.geoJSON(),b=L.geoJson(),et=L.geoJson(),n=L.map("drawMap",{zoom:14,maxZoom:19,center:[59.93863,30.31413],zoomControl:!1,crs:L.CRS.EPSG3857,layers:[ot,st,ht,ct,ut,d]}),ui={"План":ot},fi={"ЗНОП городского значения":ht,"ЗНОП местного значения":ct,"Фасады":dt,"Объекты культурного наследия":gt,"Водные объекты":ni,"Дороги":ii,"Дороги внутри муниципальных образований":ti,"Земельные участки и их части":ri},lt=L.control.activeLayers(ui,fi);lt.addTo(n);L.control.scale({imperial:!1}).addTo(n);L.control.zoom({zoomInTitle:"Приблизить",zoomOutTitle:"Отдалить"}).addTo(n);L.control.fullscreen({title:"На полный экран",titleCancel:"Свернуть карту"}).addTo(n);ei=L.Control.geocoder({defaultMarkGeocode:!1,position:"topleft",placeholder:"Введите адрес",errorMessage:"Ничего не найдено",geocoder:new L.Control.Geocoder.Nominatim({serviceUrl:o.MapServicesParams.NominatimAddress})}).on("markgeocode",function(t){var i=t.geocode.bbox,u=L.polygon([i.getSouthEast(),i.getNorthEast(),i.getNorthWest(),i.getSouthWest()]),r=[];r.push(t.geocode.center.lng);r.push(t.geocode.center.lat);hi(r);n.fitBounds(u.getBounds())}).addTo(n);at=L.control.angular({position:"topright",template:"<ng-include src='burl'><\/ng-include>",controllerAs:"lc",controller:["$scope","$element","$map","mapfactory",function(n,t,i,r){n.barView="/js/app/tmpl/dmd_cc/c_bar/c_bar.html";n.burl=n.barView;n.$watch(function(){return r.getRqid()},function(){n.rqidt=r.getRqid()});n.zoom=function(){i.zoomIn()};n.zoomO=function(){i.zoomOut()}}]});n.addControl(at);n.on("click",li,st);vt=L.tileLayer.wms(o.MapLayersLinks.MinMapToris,{});oi=new L.Control.MiniMap(vt,{toggleDisplay:!0}).addTo(n);L.drawLocal=k;yt=new L.Control.Draw({edit:{featureGroup:d,poly:{allowIntersection:!1}},draw:{circle:!1,marker:!1,circlemarker:!1,polyline:!1,rectangle:!1,polygon:{allowIntersection:!1,showArea:!0}}});si(s,n,yt);n.on(L.Draw.Event.CREATED,function(n){var h=n.layerType,i=n.layer,r=i.toGeoJSON(),o,u,t=[],s=[],e;f.setPolType(r.geometry.type);d.addLayer(n.layer);e=d.getBounds().getCenter();s=proj4(nt,[e.lng,e.lat]);f.setPolCtrWGS(e);f.setPolCtr(s);f.setGeom(r);pi(s);wi(e);switch(h){case"marker":i.bindPopup("TEST!");break;case"circle":t.push(proj4(nt,r.geometry.coordinates));f.setDrGeom(t);i.bindPopup(tt);break;case"circlemarker":t.push(proj4(nt,r.geometry.coordinates));f.setDrGeom(t);i.bindPopup(tt);break;case"rectangle":o=r.geometry.coordinates;u=o[0];u.forEach(function(n){t.push(proj4(nt,n))});f.setDrGeom(t);i.bindPopup(tt);break;case"polyline":u=r.geometry.coordinates;u.forEach(function(n){t.push(proj4(nt,n))});f.setDrGeom(t);i.bindPopup(tt);break;case"polygon":o=r.geometry.coordinates;u=o[0];u.forEach(function(n){t.push(proj4(nt,n))});f.setDrGeom(t);i.bindPopup(tt);break;default:i.bindPopup(tt)}i.openPopup();c=!0});n.on(L.Draw.Event.DRAWSTART,function(){c=!1;L.DomUtil.addClass(n._container,"crosshair-cursor-enabled");y=!0});n.on(L.Draw.Event.DRAWSTOP,function(){L.DomUtil.removeClass(n._container,"crosshair-cursor-enabled");y=!1});n.on(L.Draw.Event.DELETED,function(){n.removeLayer(b);f.setDistr(null);f.setItemEvt(null,0)});n.on("popupclose",function(){n.removeLayer(ut);n.off("popupclose",function(){})});pt=L.popup.angular({template:"<ng-include src='ppurl'><\/ng-include>",controllerAs:"dataPopup",controller:["$scope","$map","mapfactory",function(n,t,i){var r=i.getItem(),u;r&&(n.fid=r.id);n.getFeature=function(n){i.setItemEvt(n,3)};u=i.getJson();n.features=u.features;n.rqid=i.getRqid();n.popupView="/js/app/tmpl/dmd_cc/m_popup/m_popup.html";n.ppurl=n.popupView}]});tt=L.popup.angular({template:"<ng-include src='ppurl'><\/ng-include>",controllerAs:"drawPopup",controller:["$scope","$map","mapfactory","mapservice",function(n,i,r,u){function o(t,r){var f;switch(t){case"Polygon":f=u.getDWPolygon(t,r);break;case"LineString":f=u.getDWLine(t,r);break;case"Point":f=u.getDWPoint(t,r);break;default:alert("Некорректный тип геометрии!")}f.then(function(t){n.features=t.data.features;i.removeLayer(b);b=L.geoJson(t.data,{style:g}).addTo(i)},function(){alert("Нет ответа от сервера!")})}var s,f,e;n.popupView="/js/app/tmpl/dmd_cc/p_popup/p_popup.html";n.ppurl=n.popupView;s=r.getItem();s&&(n.fid=s.id);n.getFeature=function(n){r.setItemEvt(n,1)};n.gfWithRChange=function(n){r.setRqid("3");t.search("rqid",3);r.setItemEvt(n,1)};n.clsp=function(){i.closePopup()};n.getDrawGeom=function(){var n=r.getGeom();r.setItemEvt(n,2)};n.pushPoly=function(n){var t=n;r.setItemEvt(t,1)};n.cutPoly=function(n){var t=n;r.setItemEvt(t,4)};n.repPoly=function(n){var t=n;r.setItemEvt(t,5)};f=r.getPolType();e=r.getDrGeom();n.rqid=r.getRqid();switch(n.rqid){case"0":o(f,e);break;case"1":o(f,e);break;case"2":o(f,e);break;case"3":o(f,e)}}]});i.$watch(function(){return f.getItem()},function(){var n=f.getEvt();i.kKIZnopRequest.TypeId=f.getRqid();switch(n){case 0:f.setEvt(0);break;case 1:gi(d.toGeoJSON());f.setEvt(0);break;case 2:di(d.toGeoJSON());f.setEvt(0);break;case 3:wt();break;case 4:tr(d.toGeoJSON());f.setEvt(0);break;case 5:rr(d.toGeoJSON());f.setEvt(0);break;default:wt();f.setEvt(0)}});g={color:"#fff25b",weight:5,opacity:.65};bt={color:"#94b1c7",weight:5,opacity:.85};i.fileList=[];i.curFile;i.ImageProperty={file:""};kt=o.AllowedFileTypes.split(",");i.setFile=function(n){var r,t,u;for(i.fileList=[],i.fileallerts=[],r=n.files,t=0;t<r.length;t++)i.ImageProperty.file=r[t],kt.includes(i.ImageProperty.file.type)?i.fileList.push(i.ImageProperty):(u=i.ImageProperty.file.name+" - Файл имеет запрещённый тип и не будет принят. ",i.fileallerts.push(u)),i.ImageProperty={},i.$apply()};i.UploadFile=function(){for(var u=r.get("XSRF-TOKEN"),t=i.fileList.length,n=0;n<t;n++)i.UploadFileIndividual(u,i.fileList[n].file,i.fileList[n].file.name,i.fileList[n].file.type,i.fileList[n].file.size,i.requestkey,t);i.isUploadNow=!0};ft=0;i.UploadFileIndividual=function(n,t,r,u,f,e,o){function h(n){if(n.lengthComputable){var t=Math.round(n.loaded*100/n.total);t==100}}function c(){i.$apply();ft++;ft==o&&(ft=0,window.location.replace(i.redirectUrl),window.location.href)}function l(){i.isUploadNow=!1}function a(){i.isUploadNow=!1}var s=new XMLHttpRequest;s.upload.addEventListener("progress",h,!1);s.addEventListener("load",c,!1);s.addEventListener("error",l,!1);s.addEventListener("abort",a,!1);s.open("POST","/MapDraw/UploadFiles",!0);s.setRequestHeader("Content-Type","multipart/form-data");s.setRequestHeader("X-XSRF-TOKEN",n);s.setRequestHeader("X-File-Name",encodeURIComponent(r));s.setRequestHeader("X-File-Type",u);s.setRequestHeader("X-File-Size",f);s.setRequestHeader("X-File-RequestKey",e);s.send(t)};i.addMode=!0;i.toggleAdd=function(){i.addMode=!i.addMode}}function h(n){switch(n){case"ЗНОП":return 1;case"Внутриквартальное озеленение":return 2;case"Резервное озеленение":return 3;default:return 0}}function p(n){return n.features[0].geometry.type==="Polygon"?it(n):n}function l(n){return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:n}]}}function it(n){return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"MultiPolygon",coordinates:[n.features[0].geometry.coordinates]}}]}}function rt(n){return{type:"Feature",properties:{},geometry:n}}var o,a,s;n.$on("config_loaded",function(n,t){b(t);nt();d();g()});a=t.search().featureID;s=t.search().rqid;i.kKIZnopRequest={Id:0,FullName:"",CorpName:"",MailAddres:"",Thelephone:"",Position:"",ObtypeUID:"",TypeId:null,Objectid:null,SelectedStatusId:null,DistrictId:null,MunicipalDistrictId:null,OIDSvyaz:null,OID_:null,Comment:"",Address:"",ObjectName:"",Geometry:"",Lat:0,Lng:0};var c=!0,v=!1,y=!1,k={draw:{toolbar:{actions:{title:"Отменить рисование",text:"Отменить"},finish:{title:"Завершить рисование",text:"Завершить"},undo:{title:"Удалить последнюю нарисованную точку",text:"Удалить последнюю точку"},buttons:{polyline:"Нарисовать полилинию",polygon:"Создать",rectangle:"Нарисовать прямоугольник",circle:"Нарисовать окружность",marker:"Поставить маркер",circlemarker:"Поставить маркер-окружность"}},handlers:{circle:{tooltip:{start:"Нажмите и перетащите что бы выберать радиус."},radius:"Радиус"},circlemarker:{tooltip:{start:"Нжмите на карте для установки маркера-окружности."}},marker:{tooltip:{start:"Нжмите на карте для установки маркера."}},polygon:{error:"<strong>Ошибка:<\/strong> !",tooltip:{start:"Нажмите, чтобы начать рисовать полигон.",cont:"Выберете следующую точку полигона.",end:"Нажмите первую точку, чтобы замкнуть контур полигона и завершить рисование."}},polyline:{error:"<strong>Ошибка:<\/strong> Края линии не могут пересекаться!",tooltip:{start:"Нажмите, чтобы начать рисовать полилинию.",cont:"Нажмите, чтобы продолжить рисование полилинии.",end:"Нажмите последнюю точку для завершения рисования."}},rectangle:{tooltip:{start:"Нажмите и перетащите, чтобы нарисовать прямоугольник."}},simpleshape:{tooltip:{end:"Отпустите мышь, чтобы закончить рисование."}}}},edit:{toolbar:{actions:{save:{title:"Сохранить изменения",text:"Сохранить"},cancel:{title:"Отменить редактирование и все изменения",text:"Отменить"},clearAll:{title:"Очистить всю область рисования",text:"Очистить всё"}},buttons:{edit:"Редактировать",editDisabled:"Нет слоев для редактирования",remove:"Удалить",removeDisabled:"Нет слоев для удаления"}},handlers:{edit:{tooltip:{text:"Инструмент для редактирования объектов и перетаскивания маркеров",subtext:"Нажмите «Отмена», чтобы отменить изменения"}},remove:{tooltip:{text:"Нажмите на объект, чтобы удалить"}}}}};f.setRqid(s);i.features="";i.dmd_cc_m_formView="/js/app/tmpl/dmd_cc/m_form.html";i.dmd_cc_m_form=i.dmd_cc_m_formView;i.setNewGeom=function(n){return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:n}]}};i.postZnopMapDrawCreated=function(n){n.Geometry=JSON.stringify(n.Geometry);var t=u.postZnopMapDrawCreated(n);t.then(function(n){0<i.fileList.length?(i.redirectUrl=n.data.url,i.requestkey=n.data.requestkey,i.UploadFile()):(window.location.replace(n.data.url),window.location.href)},function(n){alert("Failed to send data on server!"+n.data.toString())})};i.checkRq=function(n){return n.Geometry&&n.FullName&&n.Position&&n.CorpName&&n.MailAddres&&n.Thelephone&&n.MunicipalDistrictId&&n.DistrictId?!1:!0}}angular.module("mds.areas").controller("dmd_cc",n);n.$inject=["$rootScope","$location","$scope","$cookies","mapservice","mapfactory","$filter"]}(),function(){"use strict";function n(){}angular.module("mds.areas").controller("mds.areas.mapCtrl",n);n.$inject=["$scope","$http","mapservice"]}(),function(){"use strict";function n(n,t){n.pointsFromController=[{lat:59.95868,lng:30.33418},{lat:59.97869,lng:30.35419}];n.requestURL="";n.requestData="";n.getPointsFromSomewhere=function(){t.get("/Get/Points/From/Somewhere").success(function(t){n.pointsFromController=t})}}angular.module("mds.areas").controller("mds.areas.mapDrawCtrl",n);n.$inject=["$scope","$http","mapservice","mapfactory"]}(),function(){"use strict";function n(){function n(n,t){t.hover(function(){t.tooltip("show")},function(){t.tooltip("hide")})}return{link:n,restrict:"A"}}angular.module("mds.areas").directive("tooltip",n);n.$inject=["$window"]}(),function(){"use strict";function n(){var t=null,i=null,r=null,u=null,f=null,e=[],o=null,s=null,h=null,c=null,n=0,l=0;return{getJson:function(){return t},setJson:function(n){t=n},getItem:function(){return i},setItemEvt:function(t,r){i=t;n=r},getGeom:function(){return r},setGeom:function(n){r=n},getRqid:function(){return u},setRqid:function(n){u=n},getDistr:function(){return f},setDistr:function(n){f=n},getDrGeom:function(){return e},setDrGeom:function(n){e=n},getPolType:function(){return o},setPolType:function(n){o=n},getPolCtr:function(){return s},setPolCtr:function(n){s=n},getPolCtrWGS:function(){return h},setPolCtrWGS:function(n){h=n},getAddr:function(){return c},setAddr:function(n){c=n},getEvt:function(){return n},setEvt:function(t){n=t},getConf:function(){return l},setConf:function(n){l=n}}}angular.module("mds.areas").factory("mapfactory",n);n.$inject=["$http"]}(),function(){"use strict";function n(n,t){function a(){i=h.MapServicesParams.GeoserverAddress;c=h.MapServicesParams.NominatimAddress;r=h.MapServicesParams.SrsName}var i="",c="",o="ows",s="WFS",u="1.0.0",f="GetFeature",l="1",e="application%2Fjson",r="",h;this.getConfig=function(){return t.get("/Main/Config")};n.$on("config_loaded",function(n,t){h=t;a()});this.getConf=function(){return h};this.getDistricts=function(){return t.get("/MapDraw/Districts")};this.getMunicipalDistricts=function(){return t.get("/MapDraw/MunicipalDistricts")};this.postZnopMapDrawCreated=function(n){return t({method:"post",url:"/MapDraw/ZnopMapDrawCreated",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(n){var t=[];for(var i in n)t.push(encodeURIComponent(i)+"="+encodeURIComponent(n[i]));return t.join("&")},data:n})};this.getAllJson=function(){return t.get("/Main/AllJson")};this.getCountrie=function(){return t.get("/Main/CountriesGeoJson")};this.getZNOP=function(){return t.get("/Main/ZNOPGeoJson")};this.getZNOPM=function(){return t({method:"GET",url:"http://dev5002.pob.adc.spb.ru/geoserver/znop/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=znop:znop-local&maxFeatures=50&outputFormat=application%2Fjson&srsName=EPSG:4326",dataType:"jsonp"})};this.getZNOPgor=function(){return t({method:"GET",url:"http://dev5002.pob.adc.spb.ru/geoserver/znop/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=znop:znop_gor&outputFormat=application%2Fjson&srsName=EPSG:4326",dataType:"jsonp"})};this.getZS=function(){return t.get("/MapDraw/GetZnopStatuses")};this.getFeature=function(n,i){return t({method:"post",url:"/MapDraw/GetFeature",params:{rqid:n,fid:i}})};this.getftrById=function(n){var h=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&maxFeatures="+l+"&outputFormat="+e+"&srsName="+r+"&featureID="+n;return t({method:"GET",url:h})};this.reqBBOX=function(n){return t.get(n)};this.getNearestByPoint=function(){};this.getftrByGeom=function(n,h){var l=" ",c="",a;return h.forEach(function(n,t){t>0&&(c+=",");c+=n.toString().replace(",",l)}),a=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:znop_gor,znop:znop-local&maxFeatures=50&outputFormat="+e+"&srsName="+r+"&cql_filter=Intersects(geom,"+l+"Polygon(("+c+"))) AND is_active = 'Y'",t({method:"GET",url:a})};this.getDWPolygon=function(n,h){var l=" ",c="",a;return h.forEach(function(n,t){t>0&&(c+=",");c+=n.toString().replace(",",l)}),a=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:znop_gor,znop:znop-local&maxFeatures=3&outputFormat="+e+"&srsName="+r+"&cql_filter=DWITHIN(geom,"+l+"Polygon(("+c+")),15,meters) AND is_active = 'Y'",t({method:"GET",url:a})};this.getDWPoint=function(n,h){var c=" ",l="",a;return l=h.toString().replace(",",c),a=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:znop_gor,znop:znop-local&maxFeatures=3&outputFormat="+e+"&srsName="+r+"&cql_filter=DWITHIN(geom,"+c+"Point("+l+"),15,meters) AND is_active = 'Y'",t({method:"GET",url:a})};this.getSRPoint=function(n,h){var c=" ",l="",a;return l=h.toString().replace(",",c),a=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:znop_gor,znop:znop-local,znop:okn,znop:facade,znop:ad,znop:road_mo&maxFeatures=5&outputFormat="+e+"&srsName="+r+"&cql_filter=DWITHIN(geom,"+c+"Point("+l+"),1,meters) AND is_active = 'Y'",t({method:"GET",url:a})};this.getDWLine=function(n,h){var l=" ",c="",a;return h.forEach(function(n,t){t>0&&(c+=",");c+=n.toString().replace(",",l)}),a=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:znop_gor,znop:znop-local&maxFeatures=3&outputFormat="+e+"&srsName="+r+"&cql_filter=DWITHIN(geom,"+l+"Linestring("+c+"),15,meters) AND is_active = 'Y'",t({method:"GET",url:a})};this.getftrByGeomXML=function(n,o){var s="Polygon",h="Intersects",c=o[0],l=c.toString().replaceAll(","," "),a=i+"/wfs?request="+f+"&version="+u+"&typeName=znop:znop_gor,znop:znop-local&srsName="+r+"&outputFormat="+e+"&FILTER=<Filter xmlns='http://www.opengis.net/ogc' xmlns:gml='http://www.opengis.net/gml'><"+h+"><PropertyName>geom<\/PropertyName><gml:"+s+" srsName='http://www.opengis.net/def/crs/EPSG/0/26713'><gml:exterior><gml:LinearRing><gml:posList>"+l+"<\/gml:posList><\/gml:LinearRing><\/gml:exterior><\/gml:"+s+"><\/"+h+"><\/Filter>";return t({method:"GET",url:a})};this.getDistrBP=function(n){var a=encodeURIComponent("НАЗВАНИЕ,РАЙОН"),h=" ",c="",l;return c=n.toString().replace(",",h),l=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:mo&maxFeatures=1&outputFormat="+e+"&propertyName="+a+"&srsName="+r+"&cql_filter=DWITHIN(geom,"+h+"Point("+c+"),15,meters)",t({method:"GET",url:l})};this.getAddress=function(n){var i=c+"/reverse.php?format=json&lat="+n.lat+"&lon="+n.lng+"&zoom=18&addressdetails=1&namedetails=1&accept-language=ru";return t({method:"GET",url:i})};this.getAddress_NN=function(n){var h=" ",c="",l;return c=n.toString().replace(",",h),l=i+"/"+o+"?service="+s+"&version="+u+"&request="+f+"&typeName=znop:facade&maxFeatures=1&outputFormat="+e+"&propertyName=ADDRESS&srsName="+r+"&cql_filter=DWITHIN(geom,"+h+"Point("+c+"),100,meters)",t({method:"GET",url:l})};this.getPrcAdr=function(n){var r=n.toString().replace(","," "),u=i+"/wps";return'<wfs:GetFeature service="WFS" version="1.0.0" outputFormat="application/json"><wfs:Query typeName="znop:facade"/><\/wfs:GetFeature><\/wps:Body><\/wps:Reference><\/wps:Input><wps:Input><ows:Identifier>point<\/ows:Identifier><wps:Data><wps:ComplexData mimeType="text/xml; subtype=gml/3.1.1"><![CDATA[POINT('+r+')]\]><\/wps:ComplexData><\/wps:Data><\/wps:Input><wps:Input ><ows:Identifier>crs<\/ows:Identifier><wps:Data><wps:LiteralData>EPSG:100064<\/wps:LiteralData><\/wps:Data><\/wps:Input><\/wps:DataInputs><wps:ResponseForm><wps:RawDataOutput mimeType="application/json">',t({method:"POST",url:u,data:'<?xml version="1.0" encoding="UTF-8"?><wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows ="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc = "http://www.opengis.net/ogc" xmlns:wcs = "http://www.opengis.net/wcs/1.1.1" xmlns:xlink = "http://www.w3.org/1999/xlink" xsi:schemaLocation = "http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd"><ows:Identifier>gs:Nearest<\/ows:Identifier><wps:DataInputs><wps:Input><ows:Identifier>features<\/ows:Identifier><wps:Reference mimeType="text/xml; subtype=wfs-collection/1.0" xlink:href="http://geoserver/wfs" method ="POST"><wps:Body>',headers:{"Content-Type":"application/xml"}})}}angular.module("mds.areas").service("mapservice",n);n.$inject=["$rootScope","$http"]}();